// WarChain Arena Platform - Database Schema
// Production-grade schema with proper relationships and constraints

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

enum CharacterSyncStatus {
  PENDING
  SYNCING
  SYNCED
  ERROR
  OUT_OF_SYNC
}

enum AuditAction {
  CHARACTER_IMPORT
  CHARACTER_UPDATE
  NFT_MINT
  NFT_TRANSFER
  FIGURINE_BIND
  FIGURINE_UNBIND
  OWNERSHIP_VERIFICATION
}

// Core User Model
// Represents platform users with wallet addresses for NFT ownership
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String? // bcrypt hashed password (null for OAuth users)
  walletAddress String?  @unique // Polygon wallet address (optional during registration)
  roles         UserRole @default(USER)

  // OAuth fields
  provider   String? // 'google', 'apple', or null for email/password
  providerId String? // Unique ID from OAuth provider
  oauthEmail String? // Email from OAuth provider (may differ from email)

  // Profile fields
  displayName String? // User's display name (optional)
  bio         String? // User's bio (optional)
  avatarUrl   String? // User's avatar/profile photo URL (optional)

  // Relationships
  figurines  Figurine[]
  characters Character[]
  auditLogs  AuditLog[]

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  @@index([email])
  @@index([walletAddress])
  @@index([provider, providerId])
  @@map("users")
}

// Figurine Model
// Represents physical NFC-enabled figurines bound to users
model Figurine {
  id                String  @id @default(cuid())
  nfcUid            String  @unique // Immutable, unique NFC tag identifier
  ownerId           String
  tokenId           BigInt? // NFT token ID on Polygon (null until minted)
  contractAddress   String? // NFT contract address
  linkedCharacterId String? @unique // Character linked to this figurine

  // Relationships
  owner           User       @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  linkedCharacter Character? @relation(fields: [linkedCharacterId], references: [id], onDelete: SetNull)

  // Timestamps
  boundAt   DateTime  @default(now())
  mintedAt  DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([nfcUid])
  @@index([ownerId])
  @@index([tokenId, contractAddress])
  @@map("figurines")
}

// Character Model (WCA Canonical)
// Normalized character data derived from D&D Beyond
model Character {
  id                   String  @id @default(cuid())
  dndBeyondCharacterId String? @unique // D&D Beyond character ID (if imported)
  name                 String
  class                String
  level                Int     @default(1)

  // Base D&D 5e stats
  baseStats    Json // { str, dex, con, int, wis, cha }
  derivedStats Json // { hp, ac, speed, initiative, proficiency }
  equipment    Json // Array of equipment items
  spells       Json? // Array of spells (null for non-spellcasters)

  // Metadata
  race       String?
  background String?
  alignment  String?
  campaign   String? // Campaign name from D&D Beyond

  // Sync tracking
  lastSyncAt        DateTime?
  syncStatus        CharacterSyncStatus @default(PENDING)
  syncHash          String? // SHA-256 hash of last imported data
  lastDndBeyondHash String? // Hash from D&D Beyond data for comparison

  // Raw import data snapshot
  rawImportData Json? // Full D&D Beyond JSON snapshot

  // Relationships
  ownerId   String
  owner     User       @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  figurine  Figurine?
  auditLogs AuditLog[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
  @@index([dndBeyondCharacterId])
  @@index([syncStatus])
  @@map("characters")
}

// Audit Log Model
// Tracks all critical actions for security and compliance
model AuditLog {
  id     String      @id @default(cuid())
  action AuditAction
  userId String?
  user   User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Related entities
  characterId String?
  character   Character? @relation(fields: [characterId], references: [id], onDelete: SetNull)
  figurineId  String?

  // Action metadata
  metadata  Json? // Additional context (wallet address, token ID, etc.)
  ipAddress String?
  userAgent String?

  // Timestamps
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([characterId])
  @@index([createdAt])
  @@map("audit_logs")
}
